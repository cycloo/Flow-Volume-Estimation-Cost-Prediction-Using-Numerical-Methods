# -*- coding: utf-8 -*-
"""TUBES.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1EiBtY77G6yCrYy11-PlrtBD81TR7e92X
"""

# Import libraries
import babel.numbers
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
import datetime as dt
from random import randint
from datetime import datetime
from sklearn.linear_model import LinearRegression

inpData = pd.read_csv('file:/content/log_level_out_mini.csv')

# Configure Datatypes
inpData['eTime'] = pd.to_datetime(inpData['eTime'], format = '%Y-%m-%d %H:%M:%S') # mengubah kolom 'eTime' menjadi datatype date
inpData['eValue'] = inpData['eValue'].astype('float') # mengubah kolom 'eTime' menjadi datatype float

# fungsi interpolasi
def interpolasi(x, yArray):
    yValid = [] # array untuk memasukkan value yang valid
    hArray = [] # array untuk menampung hasil yang akan di return

    for k in range(len(yArray)): # meng-loop yArray
        if yArray[k] > 0: # jika value positif, masukkan ke array yValid
            yValid.append(yArray[k])

    if yValid: # jika yValid memiliki isi, jadikan average menjadi jumlah value dalam array dibagi jumlah dalam array
        avg = sum(yValid) / len(yValid)
    else: # jika yValid kosong, ambil average dari array yArray, tetapi di absolut (jika hasil negatif, dikalikan -1)
        avg = 0
        for i in range(len(yArray)):
            avg += yArray[i]
        avg = abs(avg/len(yArray))
    for i in range(len(yArray)): # men-loop yArray
        if yArray[i] < 0: # melakukan jika value negatif
            yArray[i] = yArray[i - 1] + ((yArray[i - 1] - (yArray[i - 2])) / (x[i - 1] - x[i - 2])) * (x[i] - x[i - 1]) # menggantikan value invalid dengan menggunakan rumus lagrange interpolation
            if abs(yArray[i]) > avg * 2: # jika nilai absolut dari nilai yang telah di interpolasikan lebih dari avg*2, maka dikalikan nilai tengah / 90, agar tidak melenceng terlalu jauh dari nilai avg
                nilai_tengah = randint(50, 80)
                yArray[i] = (nilai_tengah / 90) * abs(avg)
        hArray.append(abs(yArray[i])) # masukkan hasil interpolasi ke dalam array yang akan di return
    return hArray # men return array

#inisialisasi array
yArray = []
xArray = []
x = []

# 2017-7-16 -> 2017-7-22

#input tanggal batasan awal dan tanggal batasan akhit
year1 = input("year 1: ")
month1 = input("month 1: ")
day1 = input("day 1: ")
year2 = input("year 2: ")
month2 = input("month 2: ")
day2 = input("day 2: ")

# memasukkan tanggal dalam format teks, lalu di convert ke dalam datatype date() dengan menggunakan datetime.strptime()
inpDate1 = "" + day1 + "/" + month1 + "/" + year1
inpDate2 = "" + day2 + "/" + month2 + "/" + year2
date1 = datetime.strptime(inpDate1,"%d/%m/%Y")
date2 = datetime.strptime(inpDate2,"%d/%m/%Y")

for i in range(0, len(inpData['eValue'])): # men looping dalam range index inpData['eValue']
  if (inpData['eTime'][i].date() >= date1.date()) & (inpData['eTime'][i].date() <= date2.date()): # membandingkan jika tanggal berada di dalam batasan yang telah ditentukan
    yArray.append(inpData['eValue'][i]) # memasukkan value dari inpData ke dalam yArray
    xArray.append(inpData['eTime'][i])
    x.append(float(i)) # memasukkan indeks ke dalam x

interpolated_data = interpolasi(x,yArray) # melakukan interpolasi dengan memanggil fungsi interpolasi()

#inisialisasi variabel
radius = 5.08 # radius pipa yang telah ditentukan
volumeDay = [] # array untuk menyimpan volume per hari
dayList = [xArray[0]] # array untuk menyimpan data date setiap hari berbeda
volumeTotal = 0 # data untuk menghitung jumlah volume per hari

for i in range(0, len(interpolated_data)): # men-loop data inpData['eTime']
  if (i != 0 and xArray[i].day != xArray[i-1].day) or i == len(interpolated_data) - 1: # membandingkan jika day dalam tanggal sudah berganti
    volumeDay.append(volumeTotal) # masukkan total volume ke array volumeDay
    volumeTotal = 0 # men-reset variabel volumeTotal
    if(i != len(interpolated_data)-1): # jika pergantian hari bukan dari indeks terakhir
      dayList.append(xArray[i]) # masukkan data date() ke dalam array dayList
  volumeTotal += interpolated_data[i]  * np.pi * (0.0508 ** 2) # tambahkan volume ke volume total, dengan menggunakan rumus volume = Area * flow rate

totalBiaya = 0 # variabel untuk menghitung biaya per hari
for i in range(7): # men-loop 7 kali, untuk 1 minggu
  # menentukan kategori volume setiap hari, dan mengalikan volume dengan harga di masing-masing kategori
  if volumeDay[i] <= 10: 
    tempBiaya = volumeDay[i] * 7500
  elif volumeDay[i] <= 20:
    tempBiaya = volumeDay[i] * 8750
  else:
    tempBiaya = volumeDay[i] * 11000
  totalBiaya += tempBiaya # menambahkan biaya ke totalBiaya
  print(dayList[i].strftime('%Y-%m-%d'),"- Jumlah yang harus dibayar: ",babel.numbers.format_currency(round(tempBiaya,2),"IDR", locale='id_ID')) # men-print jumlah yang harus dibayar di dalam setiap hari
print("Total Biaya: ",babel.numbers.format_currency(round(totalBiaya,2),"IDR", locale='id_ID'))

# Estimasi data menggunakan regresi linear

x = np.array([1,2,3,4,5,6,7]) #inisialisasi index untuk minggu pertama
y = np.array(volumeDay) # mengambil data volume per hari dari array volumeDay

# melakukan linear regression menggunakan sklearn
k, d = np.polyfit(x, y, 1)
y_pred = k*x + d

reg = LinearRegression()
x = np.array([1,2,3,4,5,6,7]).reshape((-1, 1))
reg.fit(x, y)

#prediksi 3 minggu kedepan
toFind = np.array([8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28]).reshape((-1, 1)) # inisialisasi index untuk minggu 2-4
dayBiaya = reg.predict(toFind) # menaruh hasil linear regression ke dalam array dayBiaya

#hitung 3 minggu kedepan
count = 8 # variabel untuk menghitung hari ke-
totalBiayaEstimasi = 0 # variabel untuk menyimpan total biaya minggu 2-4
for i in dayBiaya: # looping value di dayBiaya ke dalam variabel i, dan mengalikannya dengan harga sesuai kategori
  if i <= 10:
    tempBiaya = i * 7500
  elif i <= 20:
    tempBiaya = i * 8750
  else:
    tempBiaya = i * 11000
  totalBiayaEstimasi += tempBiaya # menambahkan biaya ke totalBiayaEstimasi
  print("Hari ke-",count,": ",babel.numbers.format_currency(round(tempBiaya,2),"IDR", locale='id_ID')) # men-print jumlah yang harus dibayar di dalam setiap hari
  count+=1 # men-iterasikan variabel
totalBiaya += totalBiayaEstimasi # menambahkan biaya minggu 2-4 ke biaya minggu 1
print("Total Biaya Minggu 2-4: ",babel.numbers.format_currency(round(totalBiayaEstimasi,2),"IDR", locale='id_ID'))
print("Total Biaya Minggu 1-4: ",babel.numbers.format_currency(round(totalBiaya,2),"IDR", locale='id_ID'))